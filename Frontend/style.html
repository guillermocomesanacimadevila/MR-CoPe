<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MR-CoPe | Mendelian Randomisation Dashboard</title>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <!-- Style -->
  <style>
    :root{
      --bg:#f7f8fb;--card-bg:#fff;--accent:#356cf2;--accent-2:#009e73;--danger:#e74c3c;
      --text:#1a1d29;--muted:#6c738a;--table-head:#1f2433;--border:#e6e9f2;
      --shadow:0 10px 30px rgba(40,56,116,.10);--radius:20px;--font:'Inter',system-ui,Arial,sans-serif
    }
    [data-theme="dark"]{
      --bg:#161a22;--card-bg:#1f2430;--accent:#3ecfff;--accent-2:#24d2a6;--danger:#f35d5d;
      --text:#e7e9f3;--muted:#9aa3ba;--table-head:#e6e9f2;--border:#2d3646;--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);font-size:16px}
    .container{max-width:1240px;margin:18px auto 64px;padding:0 18px}
    h1{font-size:2.05rem;letter-spacing:-.02em;margin:.2rem 0 0;color:var(--accent);font-weight:800}
    h2{font-weight:800;letter-spacing:-.02em;margin:0 0 .7rem}
    .subhead{color:var(--muted);margin:.35rem 0 1.8rem}
    .grid-kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:14px;margin:18px 0 26px}
    .kpi{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .kpi h3{margin:0;color:var(--muted);font-size:.95rem;font-weight:700}
    .kpi .val{font-size:1.9rem;font-weight:900;letter-spacing:-.02em;margin-top:2px;color:var(--table-head)}
    .section{background:var(--card-bg);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin:18px 0 28px}
    .section-header{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:baseline;margin-bottom:10px}
    .pill{display:inline-block;border:1px solid var(--border);padding:.25rem .55rem;border-radius:999px;font-size:.82rem;color:var(--muted);white-space:nowrap}
    .tabbed .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);margin:6px 0 12px;flex-wrap:wrap}
    .tab{background:transparent;border:none;color:var(--accent);font-weight:800;padding:.7rem 1rem;border-top-left-radius:12px;border-top-right-radius:12px;border-bottom:3px solid transparent;cursor:pointer}
    .tab.active,.tab:hover{border-bottom:3px solid var(--accent);color:var(--table-head);background:var(--bg)}
    .tab-content{display:none;animation:fade .25s ease}
    .tab-content.active{display:block}
    @keyframes fade{from{opacity:.6}to{opacity:1}}

    /* Figures */
    .fig-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
    .fig{background:var(--card-bg);border:1px solid var(--border);border-radius:14px;padding:10px}
    .fig h4{margin:6px 8px 10px;font-weight:800}
    .fig img{width:100%;height:auto;border-radius:10px;border:1px solid var(--border);display:block}

    /* Tables wrapper */
    .table-wrap{width:100%;overflow:auto;border-radius:12px}
    .mr-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden}
    .mr-table th,.mr-table td{padding:.75rem;border-bottom:1px solid var(--border);text-align:center;vertical-align:middle}
    .mr-table thead th{position:sticky;top:0;z-index:1;background:var(--bg)}
    .compact td,.compact th{padding:.55rem .5rem !important}
    .nowrap{white-space:nowrap}
    .num{text-align:right}
    .muted{color:var(--muted)}

    .footer{margin-top:28px;text-align:center;color:var(--muted);font-size:.95rem}
    .theme{position:fixed;right:18px;top:14px;border:1px solid var(--border);background:var(--card-bg);color:var(--accent);border-radius:12px;padding:.48rem .7rem;cursor:pointer;box-shadow:var(--shadow)}
    ::selection{background:var(--accent);color:#fff}
    @media (max-width:760px){h1{font-size:1.5rem}}
  </style>
</head>
<body>
  <button class="theme" id="theme-toggle"><i class="fa-solid fa-circle-half-stroke"></i> Theme</button>

  <div class="container">
    <h1>üß¨ MR-CoPe Report</h1>
    <div class="subhead"><strong>Date:</strong> <span id="today"></span></div>

    <!-- KPIs -->
    <div class="grid-kpi">
      <div class="kpi"><h3>üß¨ Instruments</h3><div class="val"><!-- SNP_COUNT --></div></div>
      <div class="kpi"><h3>‚úÖ Passed QC</h3><div class="val"><!-- QC_COUNT --></div></div>
      <div class="kpi"><h3>üìà IVW OR [95% CI]</h3><div class="val"><!-- IVW_OR --> <span class="pill"><!-- IVW_CI --></span></div></div>
      <div class="kpi"><h3>üìâ IVW p-value</h3><div class="val"><!-- IVW_P --></div></div>
    </div>

    <!-- MR summary -->
    <div class="section">
      <div class="section-header">
        <h2>üßÆ Mendelian Randomisation Results</h2>
        <span class="pill">heterogeneity &amp; intercept</span>
      </div>
      <div class="table-wrap">
        <table class="mr-table compact">
          <thead>
            <tr>
              <th>MR Method</th><th>OR</th><th>95% CI</th><th>p-value</th>
              <th>Cochran Q</th><th>Q p-value</th><th>I¬≤ (%)</th><th>Egger intercept p-value</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>IVW</td><td class="num"><!-- IVW_OR --></td><td class="nowrap"><!-- IVW_CI --></td><td class="num"><!-- IVW_P --></td><td class="num"><!-- IVW_Q --></td><td class="num"><!-- IVW_QP --></td><td class="num"><!-- IVW_I2 --></td><td class="muted">‚Äî</td></tr>
            <tr><td>Weighted median</td><td class="num"><!-- WME_OR --></td><td class="nowrap"><!-- WME_CI --></td><td class="num"><!-- WME_P --></td><td class="muted">‚Äî</td><td class="muted">‚Äî</td><td class="num">‚Äî</td><td class="muted">‚Äî</td></tr>
            <tr><td>MR Egger</td><td class="num"><!-- EGGER_OR --></td><td class="nowrap"><!-- EGGER_CI --></td><td class="num"><!-- EGGER_P --></td><td class="num"><!-- EGGER_Q --></td><td class="num"><!-- EGGER_QP --></td><td class="num"><!-- EGGER_I2 --></td><td class="num"><!-- EGGER_INT_P --></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tabs: SNPs / Figures / Methods / MR-PRESSO / Downloads -->
    <div class="tabbed section">
      <div class="tabs">
        <button class="tab active" data-tab="t1"><i class="fa-solid fa-dna"></i> SNP table</button>
        <button class="tab" data-tab="t4"><i class="fa-solid fa-images"></i> Static figures</button>
        <button class="tab" data-tab="t5"><i class="fa-solid fa-table"></i> Method summary</button>
        <button class="tab" data-tab="t7"><i class="fa-solid fa-wand-magic-sparkles"></i> MR-PRESSO</button>
        <button class="tab" data-tab="t6"><i class="fa-solid fa-download"></i> Downloads</button>
      </div>

      <!-- t1: SNP table -->
      <div id="t1" class="tab-content active">
        <div class="section-header">
          <h2>üìä SNP summary (harmonised)</h2>
          <span class="pill">alleles ‚Ä¢ betas ‚Ä¢ SE ‚Ä¢ p ‚Ä¢ EAF ‚Ä¢ F ‚Ä¢ IVW OR</span>
        </div>
        <div class="table-wrap">
          <table id="snpTable" class="display nowrap compact" style="width:100%">
            <thead>
              <tr>
                <th>rsID</th>
                <th>CHR</th>
                <th>BP</th>
                <th>EA (Exp)</th>
                <th>OA (Exp)</th>
                <th>EA (Out)</th>
                <th>OA (Out)</th>
                <th>Œ≤ Exp</th>
                <th>SE Exp</th>
                <th>P Exp</th>
                <th>Œ≤ Out</th>
                <th>SE Out</th>
                <th>P Out</th>
                <th>EAF Exp</th>
                <th>EAF Out</th>
                <th>F</th>
                <th>IVW OR</th>
                <th>95% CI (IVW)</th>
              </tr>
            </thead>
            <tbody><!-- SNP_TABLE_ROWS --></tbody>
          </table>
        </div>
      </div>

      <!-- t4: static figures -->
      <div id="t4" class="tab-content">
        <div class="section-header">
          <h2>üñºÔ∏è Static figures</h2>
          <span class="pill">auto-embedded</span>
        </div>
        <div class="fig-grid">
          <div class="fig"><h4>Combined MR scatter</h4><img id="img_scatter_combined" alt="MR_Scatter_Combined"/></div>
          <div class="fig"><h4>Leave-one-out (IVW)</h4><img id="img_leave_one_out" alt="MR_LeaveOneOut"/></div>
          <div class="fig"><h4>Method summary</h4><img id="img_summary_est" alt="mr_summary_estimates"/></div>
          <div class="fig"><h4>Forest (top SNPs)</h4><img id="img_forest_static" alt="ivw_per_snp_forest_plot"/></div>
          <div class="fig"><h4>Exposure Manhattan</h4><img id="img_man_exp" alt="exposure_manhattan"/></div>
          <div class="fig"><h4>Outcome Manhattan</h4><img id="img_man_out" alt="outcome_manhattan"/></div>
          <div class="fig"><h4>Exposure Q-Q</h4><img id="img_qq_exp" alt="exposure_qq"/></div>
          <div class="fig"><h4>Outcome Q-Q</h4><img id="img_qq_out" alt="outcome_qq"/></div>
          <div class="fig"><h4>F-statistics Histogram</h4><img id="img_fstat_hist" alt="Fstat_Histogram"/></div>
          <div class="fig"><h4>F-statistics Density</h4><img id="img_fstat_density" alt="Fstat_Density"/></div>
          <div class="fig"><h4>Funnel Plot</h4><img id="img_funnel" alt="Funnel_Plot"/></div>
        </div>
      </div>

      <!-- t5: method table -->
      <div id="t5" class="tab-content">
        <div class="section-header"><h2>üìã Method summary</h2></div>
        <div class="table-wrap">
          <table id="methodTable" class="display nowrap compact" style="width:100%">
            <thead>
              <tr><th>Method</th><th>Estimate</th><th>SE</th><th>p-value</th><th>CI lower</th><th>CI upper</th><th># SNPs</th></tr>
            </thead>
            <tbody><!-- METHOD_TABLE_ROWS --></tbody>
          </table>
        </div>
      </div>

      <!-- t7: MR-PRESSO -->
      <div id="t7" class="tab-content">
        <div class="section-header">
          <h2>ü™Ñ MR-PRESSO</h2>
          <span class="pill">global pleiotropy ‚Ä¢ outliers ‚Ä¢ distortion ‚Ä¢ adjusted IVW</span>
        </div>

        <!-- Summary cards -->
        <div class="grid-kpi" style="margin-top:0">
          <div class="kpi"><h3>Global test (p)</h3><div class="val"><!-- PRESSO_GLOBAL_P --></div></div>
          <div class="kpi"><h3># Outliers</h3><div class="val"><!-- PRESSO_N_OUT --></div></div>
          <div class="kpi"><h3>Distortion (p)</h3><div class="val"><!-- PRESSO_DIST_P --></div></div>
          <div class="kpi"><h3>IVW (PRESSO-adj)</h3>
            <div class="val"><!-- PRESSO_IVW_OR --> <span class="pill"><!-- PRESSO_IVW_CI --></span></div>
            <div class="muted" style="margin-top:6px">p = <!-- PRESSO_IVW_P --> &nbsp;|&nbsp; Œî vs IVW = <!-- PRESSO_DELTA --></div>
          </div>
        </div>

        <!-- Optional plot -->
        <div class="fig-grid" style="margin-top:10px">
          <div class="fig"><h4>Outlier overview</h4><img id="img_presso_plot" alt="MR_PRESSO_Outlier_Plot"/></div>
        </div>

        <!-- Outliers table -->
        <div class="section" style="margin-top:14px">
          <div class="section-header"><h2>üö© Outlier SNPs</h2><span class="pill">from MR-PRESSO outlier test</span></div>
          <div class="table-wrap">
            <table id="pressoTable" class="display nowrap compact" style="width:100%">
              <thead>
                <tr><th>SNP</th><th>RSSobs</th><th>p-value</th></tr>
              </thead>
              <tbody><!-- PRESSO_OUTLIER_ROWS --></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- t6: downloads -->
      <div id="t6" class="tab-content">
        <div class="section-header"><h2>‚¨áÔ∏è Downloads</h2><span class="pill">CSV exports</span></div>
        <p style="margin:.2rem 0 0; display:flex; flex-wrap:wrap; gap:8px;">
          <a href="MR_Formatted_Results.csv" download class="pill">MR_Formatted_Results.csv</a>
          <a href="MR_IVW_OR_Per_SNP.csv" download class="pill">MR_IVW_OR_Per_SNP.csv</a>
          <a href="harmonised_data.csv" download class="pill">harmonised_data.csv</a>
          <a href="mr_presso_summary.csv" download class="pill">mr_presso_summary.csv</a>
          <a href="mr_presso_outliers.csv" download class="pill">mr_presso_outliers.csv</a>
        </p>
      </div>
    </div>

    <div class="footer">MR-CoPe ‚Äî Open Source ‚Äî v1.0 ‚Äî <a href="mailto:gcc46@bath.ac.uk" style="color:inherit">Contact</a></div>
  </div>

  <!-- Minimal JS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

  <script>
    // Date
    document.getElementById("today").textContent = new Date().toLocaleDateString();
    function adjustTables(){ setTimeout(()=>{$($.fn.dataTable.tables(true)).DataTable().columns.adjust();},0); }

    // Theme
    function toggleTheme(){
      const r=document.documentElement;
      const t=r.getAttribute("data-theme")==="light"?"dark":"light";
      r.setAttribute("data-theme",t);
      localStorage.setItem("mrcope-theme",t);
      adjustTables();
    }
    (function(){
      const t=localStorage.getItem("mrcope-theme");
      if(t) document.documentElement.setAttribute("data-theme",t);
    })();
    document.getElementById("theme-toggle").onclick = toggleTheme;

    // Tabs
    $(document).on("click",".tab",function(){
      const id=$(this).data("tab");
      $(".tab").removeClass("active"); $(this).addClass("active");
      $(".tab-content").removeClass("active"); $("#"+id).addClass("active");
      adjustTables();
    });

    // Tables
    $(document).ready(function(){
      $('#snpTable').DataTable({
        dom:'Bfrtip',
        buttons:[
          {extend:'csv',text:'<i class="fa-solid fa-download"></i> CSV',className:'btn-csv'},
          {extend:'colvis',text:'<i class="fa-solid fa-table-cells"></i> Columns'}
        ],
        autoWidth:false,
        deferRender:true,
        scrollX:true,
        paging:true, pageLength:25,
        lengthMenu:[[10,25,50,100,-1],[10,25,50,100,'All']],
        language:{search:"üîé Search SNPs:"},
        columnDefs:[
          {targets:[1,2,7,8,9,10,11,12,13,14,15,16], className:'num'},
          {targets:'_all', className:'nowrap'}
        ]
      });
      $('#methodTable').DataTable({
        dom:'Bfrtip',
        buttons:[
          {extend:'csv',text:'<i class="fa-solid fa-download"></i> CSV',className:'btn-csv'},
          {extend:'colvis',text:'<i class="fa-solid fa-table-cells"></i> Columns'}
        ],
        autoWidth:false,
        scrollX:true, paging:false, searching:false, info:false,
        columnDefs:[{targets:[1,2,3,4,5,6], className:'num'}]
      });

      // PRESSO outliers table
      $('#pressoTable').DataTable({
        autoWidth:false,
        scrollX:true, paging:false, searching:false, info:false,
        columnDefs:[{targets:[1,2], className:'num'}]
      });

      adjustTables();
      window.addEventListener('resize', adjustTables);
    });

    // Static figure src (file paths injected by 07_generate_html_report.py)
    const IMG = {
      scatterCombined: '<!-- SCATTER_COMBINED_SRC -->',
      leaveOneOut:     '<!-- LOO_SRC -->',
      summaryEst:      '<!-- SUMMARY_EST_SRC -->',
      forestStatic:    '<!-- FOREST_STATIC_SRC -->',
      manExp:          '<!-- MANHATTAN_EXPOSURE_SRC -->',
      manOut:          '<!-- MANHATTAN_OUTCOME_SRC -->',
      qqExp:           '<!-- QQ_EXPOSURE_SRC -->',
      qqOut:           '<!-- QQ_OUTCOME_SRC -->',
      fstatHist:       '<!-- FSTAT_HIST_SRC -->',
      fstatDensity:    '<!-- FSTAT_DENSITY_SRC -->',
      funnelPlot:      '<!-- FUNNEL_SRC -->'
    };
    function setImg(id, src, title){
      const el=document.getElementById(id);
      if(src && src.length){ el.src = src; el.alt = title; }
      else { el.parentElement.innerHTML = `<div class="fig" style="padding:12px;border:1px dashed var(--border);border-radius:12px;color:#999;text-align:center;">${title} (missing)</div>`; }
    }
    setImg('img_scatter_combined', IMG.scatterCombined, 'MR_Scatter_Combined.png');
    setImg('img_leave_one_out',    IMG.leaveOneOut,     'MR_LeaveOneOut.png');
    setImg('img_summary_est',      IMG.summaryEst,      'mr_summary_estimates.png');
    setImg('img_forest_static',    IMG.forestStatic,    'ivw_per_snp_forest_plot.png');
    setImg('img_man_exp',          IMG.manExp,          'exposure_manhattan.png');
    setImg('img_man_out',          IMG.manOut,          'outcome_manhattan.png');
    setImg('img_qq_exp',           IMG.qqExp,           'exposure_qq.png');
    setImg('img_qq_out',           IMG.qqOut,           'outcome_qq.png');
    setImg('img_fstat_hist',       IMG.fstatHist,       'Fstat_Histogram.png');
    setImg('img_fstat_density',    IMG.fstatDensity,    'Fstat_Density.png');
    setImg('img_funnel',           IMG.funnelPlot,      'Funnel_Plot.png');

    // PRESSO plot (optional)
    (function(){
      const src = '<!-- PRESSO_PLOT_SRC -->';
      const el = document.getElementById('img_presso_plot');
      if(src && src.length){ el.src = src; el.alt = 'mr_presso_outlier_plot.png'; }
      else { el.parentElement.innerHTML = `<div class="fig" style="padding:12px;border:1px dashed var(--border);border-radius:12px;color:#999;text-align:center;">PRESSO outlier plot (missing)</div>`; }
    })();
  </script>
</body>
</html>
